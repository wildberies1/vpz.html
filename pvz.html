<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wildberries ‚Äî –ü–í–ó</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #f0f0ff 0%, #e0e0ff 100%);
      color: #333;
      min-height: 100vh;
    }
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
    }
    #login-screen {
      display: flex;
      background: linear-gradient(135deg, #6c5ce7 0%, #5d4de0 100%);
      color: white;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
    .logo {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 25px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input, button, select {
      padding: 14px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 400px;
    }
    input {
      background: white;
      color: #333;
    }
    button {
      cursor: pointer;
      background: #6c5ce7;
      color: white;
      border: none;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #5d4de0;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
    .btn-success {
      background: #2ecc71;
    }
    .btn-success:hover {
      background: #27ae60;
    }
    .btn-warning {
      background: #f39c12;
    }
    .btn-warning:hover {
      background: #d35400;
    }
    .order-card {
      background: white;
      border-radius: 12px;
      padding: 18px;
      margin: 15px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-left: 4px solid #6c5ce7;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    .header h2 {
      color: #6c5ce7;
    }
    .qr-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      text-align: center;
      margin: 20px auto;
      max-width: 300px;
    }
    .qr-header {
      color: #6c5ce7;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .qr-barcode {
      margin: 15px 0;
      font-family: monospace;
      font-size: 16px;
    }
    .review-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .rating {
      color: #f39c12;
      font-size: 20px;
      margin: 8px 0;
    }
    .location-input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #6c5ce7;
      border-radius: 8px;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="login-screen" class="screen">
  <div class="logo">–ü–í–ó Wildberries</div>
  <h2>–í—Ö–æ–¥ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>
  <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∫–∞—Å—Å–∏—Ä–∞</p>
  <input type="password" id="password-input" placeholder="–ü–∞—Ä–æ–ª—å" maxlength="4" autofocus />
  <button onclick="login()">–í–æ–π—Ç–∏</button>
</div>

<!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="main-screen" class="screen">
  <div class="header">
    <h2>üì¶ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ ‚Äî –ë–∞–ª–∞—à–∏—Ö–∞</h2>
    <div>
      <button onclick="showNewOrders()">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</button>
      <button onclick="showReviews()">–û—Ç–∑—ã–≤—ã</button>
      <button onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
  </div>
  <div id="main-content">
    <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.</p>
    <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
      <div class="order-card">
        <h3>üì• –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</h3>
        <p>–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–µ –∑–∞–∫–∞–∑—ã</p>
        <button onclick="showNewOrders()">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="order-card">
        <h3>‚≠ê –û—Ç–∑—ã–≤—ã</h3>
        <p>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
        <button onclick="showReviews()">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã -->
<div id="new-orders-screen" class="screen">
  <div class="header">
    <h2>üÜï –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</h2>
    <button onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
  <div id="new-orders-list"></div>
</div>

<!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏—ë–º–∞ –∑–∞–∫–∞–∑–∞ -->
<div id="receive-screen" class="screen">
  <div class="header">
    <h2>üñ®Ô∏è –ü—Ä–∏—ë–º –∑–∞–∫–∞–∑–∞</h2>
    <button onclick="backToNewOrders()">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
  <div id="order-details"></div>
  <div class="qr-container" id="qr-container" style="display:none;">
    <div class="qr-header">WB</div>
    <div id="qr-code"></div>
    <div class="qr-barcode" id="barcode-number"></div>
  </div>
  <input type="text" class="location-input" id="location-input" placeholder="–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–ª–∫–∞ 12)" />
  <button class="btn-success" onclick="confirmReceive()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏—ë–º</button>
</div>

<!-- –û—Ç–∑—ã–≤—ã -->
<div id="reviews-screen" class="screen">
  <div class="header">
    <h2>‚≠ê –û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
    <button onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
  </div>
  <div id="reviews-list"></div>
</div>

<script>
  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ===
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const CASHIER_PASSWORD = "0506";
  let currentOrderKey = null;
  let currentOrder = null;

  // === –í—Ö–æ–¥ ===
  function login() {
    if (document.getElementById("password-input").value === CASHIER_PASSWORD) {
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("main-screen").style.display = "flex";
      loadReviews(); // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã —Å—Ä–∞–∑—É
    } else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    }
  }

  function logout() {
    document.getElementById("main-screen").style.display = "none";
    document.getElementById("new-orders-screen").style.display = "none";
    document.getElementById("receive-screen").style.display = "none";
    document.getElementById("reviews-screen").style.display = "none";
    document.getElementById("login-screen").style.display = "flex";
    document.getElementById("password-input").value = "";
  }

  function backToMain() {
    document.getElementById("new-orders-screen").style.display = "none";
    document.getElementById("receive-screen").style.display = "none";
    document.getElementById("reviews-screen").style.display = "none";
    document.getElementById("main-screen").style.display = "flex";
  }

  function backToNewOrders() {
    document.getElementById("receive-screen").style.display = "none";
    document.getElementById("new-orders-screen").style.display = "flex";
    loadNewOrders();
  }

  // === –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã ===
  function showNewOrders() {
    document.getElementById("main-screen").style.display = "none";
    document.getElementById("new-orders-screen").style.display = "flex";
    loadNewOrders();
  }

  function loadNewOrders() {
    const list = document.getElementById("new-orders-list");
    list.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤...</p>";

    db.ref('orders')
      .orderByChild('status')
      .equalTo('created')
      .once('value')
      .then(snapshot => {
        list.innerHTML = "";
        if (!snapshot.exists()) {
          list.innerHTML = "<p>–ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.</p>";
          return;
        }

        snapshot.forEach(child => {
          const order = child.val();
          const div = document.createElement("div");
          div.className = "order-card";
          div.innerHTML = `
            <h3>–ó–∞–∫–∞–∑ ‚Ññ${child.key.slice(-6)}</h3>
            <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.userId}</p>
            <p><strong>–°—É–º–º–∞:</strong> ${order.total} ‚ÇΩ</p>
            <p><strong>–û–ø–ª–∞—Ç–∞:</strong> ${order.paymentMethod === 'cash' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–û–Ω–ª–∞–π–Ω'}</p>
            <p><strong>–¢–æ–≤–∞—Ä–æ–≤:</strong> ${order.items.length}</p>
            <button class="btn-success" onclick="prepareReceive('${child.key}', ${JSON.stringify(order).replace(/'/g, "\\'")})">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
          `;
          list.appendChild(div);
        });
      });
  }

  // === –ü—Ä–∏—ë–º –∑–∞–∫–∞–∑–∞ ===
  function prepareReceive(orderKey, order) {
    currentOrderKey = orderKey;
    currentOrder = order;
    document.getElementById("new-orders-screen").style.display = "none";
    document.getElementById("receive-screen").style.display = "flex";

    const details = document.getElementById("order-details");
    details.innerHTML = `
      <h3>–ó–∞–∫–∞–∑ ‚Ññ${orderKey.slice(-6)}</h3>
      <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.userId}</p>
      <p><strong>–°—É–º–º–∞:</strong> ${order.total} ‚ÇΩ</p>
      <p><strong>–û–ø–ª–∞—Ç–∞:</strong> ${order.paymentMethod === 'cash' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–û–Ω–ª–∞–π–Ω'}</p>
      <h4>–¢–æ–≤–∞—Ä—ã:</h4>
      <ul>${order.items.map(item => `<li>${item.name} ‚Äî ${item.price} ‚ÇΩ</li>`).join('')}</ul>
    `;

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
    const qrData = JSON.stringify({
      orderId: orderKey,
      pvz: "PVZ_BALASHIHA_32D",
      timestamp: Date.now()
    });

    document.getElementById("qr-code").innerHTML = "";
    new QRCode(document.getElementById("qr-code"), {
      text: qrData,
      width: 180,
      height: 180
    });

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ (EAN-13 –∏–º–∏—Ç–∞—Ü–∏—è)
    const now = Date.now().toString().slice(-9);
    const nameHash = order.items[0].name.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0).toString().replace('-', '').slice(0,3);
    let code12 = (now + nameHash).padEnd(12, '0').slice(0,12);
    let sum = 0;
    for (let i = 0; i < 12; i++) {
      sum += parseInt(code12[i]) * (i % 2 === 0 ? 1 : 3);
    }
    const check = (10 - (sum % 10)) % 10;
    const barcode = code12 + check;
    document.getElementById("barcode-number").textContent = barcode;
    document.getElementById("qr-container").style.display = "block";
  }

  function confirmReceive() {
    const location = document.getElementById("location-input").value.trim();
    if (!location) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è!");
      return;
    }

    db.ref('orders/' + currentOrderKey).update({
      status: "received",
      location: location,
      receivedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      // –ì–æ–ª–æ—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if ('speechSynthesis' in window) {
        const msg = `–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ. –ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è: ${location}.`;
        const utterance = new SpeechSynthesisUtterance(msg);
        utterance.lang = 'ru-RU';
        speechSynthesis.speak(utterance);
      }

      alert("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç! –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.");
      document.getElementById("receive-screen").style.display = "none";
      showNewOrders();
    }).catch(err => {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—ë–º–µ –∑–∞–∫–∞–∑–∞: " + err.message);
    });
  }

  // === –û—Ç–∑—ã–≤—ã ===
  function showReviews() {
    document.getElementById("main-screen").style.display = "none";
    document.getElementById("reviews-screen").style.display = "flex";
    loadReviews();
  }

  function loadReviews() {
    const list = document.getElementById("reviews-list");
    list.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</p>";

    // –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –æ—Ç–∑—ã–≤—ã —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –±—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    // –ó–¥–µ—Å—å –∏–º–∏—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –∑–∞–∫–∞–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "issued"
    db.ref('orders')
      .orderByChild('status')
      .equalTo('issued')
      .limitToLast(10)
      .once('value')
      .then(snapshot => {
        list.innerHTML = "";
        if (!snapshot.exists()) {
          list.innerHTML = "<p>–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>";
          return;
        }

        let count = 0;
        snapshot.forEach(child => {
          if (count >= 5) return;
          const order = child.val();
          const div = document.createElement("div");
          div.className = "review-card";
          // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–∑—ã–≤–∞
          const rating = Math.floor(Math.random() * 2) + 4; // 4 –∏–ª–∏ 5
          const comments = [
            "–û—Ç–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å!",
            "–ë—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ!",
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å!",
            "–í—Å—ë –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å!",
            "–†–µ–∫–æ–º–µ–Ω–¥—É—é —ç—Ç–æ—Ç –ü–í–ó!"
          ];
          const comment = comments[Math.floor(Math.random() * comments.length)];

          div.innerHTML = `
            <div class="rating">{"‚òÖ".repeat(rating)}{"‚òÜ".repeat(5 - rating)}</div>
            <p>${comment}</p>
            <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.userId}</p>
            <p><strong>–î–∞—Ç–∞:</strong> ${new Date(order.issuedAt).toLocaleDateString()}</p>
          `;
          list.appendChild(div);
          count++;
        });
      });
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  document.getElementById("login-screen").style.display = "flex";
</script>

</body>
</html>
